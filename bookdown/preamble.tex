% Don't hyphenate
\usepackage[none]{hyphenat}

% Widow control
\usepackage[defaultlines=3,all]{nowidow}

% Footnotes
\addtolength{\skip\footins}{1.5pc plus 5pt} % Footnote spacing from text
\setlength{\footnotesep}{1.2pc} % Space between footnotes

% CS colors
\usepackage{xcolor}
\definecolor{CSblue}{HTML}{3960A5}
\definecolor{CSbluelight}{HTML}{4878CE}
\definecolor{CSgreen}{HTML}{008000}
\definecolor{capcol}{HTML}{087830}
\definecolor{graycaption}{HTML}{595959}
\definecolor{chap}{HTML}{E03616}
\definecolor{calloutbackground}{HTML}{F2F3F4}
\definecolor{calloutborder}{HTML}{0096C8}
\definecolor{exampleborder}{HTML}{EBEDEF}
\definecolor{examplebackground}{HTML}{FBFCFC}
\definecolor{definitionborder}{HTML}{EBEDEF}
\definecolor{definitionbackground}{HTML}{FBFCFC}

% Font
  
  %% Main serif fonts with math
    \usepackage{amsmath}
    \usepackage{fontspec}
    \defaultfontfeatures{Ligatures=TeX}
    \setmainfont{STIXTwoText}[ 
    Extension = {.otf}, 
    UprightFont = {*-Regular}, 
    ItalicFont = {*-Italic}, 
    BoldFont = {*-Bold}, 
    BoldItalicFont = {*-BoldItalic}
    ]
    \setmathfont{STIX Two Math}
    \setmathfont{STIX Two Math}[range={scr,bfscr}, StylisticSet=1]
    \usepackage{bm} 
 
    %% Sans serif font
    \usepackage[sfdefault]{sourcesanspro}


% Captions and subfigures
\usepackage{caption}
\captionsetup[figure]{width=0.8\linewidth}
\captionsetup[table]{width=0.8\linewidth}
\usepackage[labelfont={color=graycaption,bf}]{caption}
\usepackage[font={small,color=graycaption}]{caption}
\captionsetup[table]{font=sf} % Sans serif caption font
\captionsetup[figure]{font=sf} % Sans serif caption font
\usepackage{subfig}
%\setlength\abovecaptionskip{-5pt}
%\captionsetup[figure]{skip=0pt}

\usepackage{array}

% Package to tweak width
\usepackage{varwidth}

% For positioning figures
\usepackage{wrapfig}
\usepackage{float}
\floatplacement{figure}{H}
\renewcommand{\topfraction}{.85}
\renewcommand{\bottomfraction}{.7}
\renewcommand{\textfraction}{.15}
\renewcommand{\floatpagefraction}{.66}
\setcounter{topnumber}{3}
\setcounter{bottomnumber}{3}
\setcounter{totalnumber}{4}

% Titles and chapters
\usepackage{sectsty}
\allsectionsfont{\bfseries\sourcesanspro\color{chap}}
\sectionfont{\bfseries\LARGE\sourcesanspro\color{chap}}
\subsectionfont{\bfseries\Large\sourcesanspro\color{chap}}
\subsubsectionfont{\bfseries\large\sourcesanspro\color{black}}
\usepackage[nobottomtitles*]{titlesec}
\titlespacing\section{0pt}{12pt plus 4pt minus 2pt}{8pt plus 4pt minus 2pt}
\titlespacing\subsection{0pt}{8pt plus 4pt minus 2pt}{6pt plus 4pt minus 2pt}
\titlespacing\subsubsection{0pt}{6pt plus 4pt minus 2pt}{4pt plus 4pt minus 2pt}

  %% Chapter number and title in the same line
  \titleformat{\chapter}[display]
    {\normalfont\Large\bfseries\sourcesanspro\color{black}}
    {\chaptertitlename\ \thechapter}{0em}
    {\Huge\bfseries\sourcesanspro\color{chap}}


% Keep things together, page breaks
\makeatletter       %% <- make @ usable in command sequences
\@secpenalty=0      %% <- don't encourage breaks before section heading
\@beginparpenalty=0 %% <- don't encourage breaks at start of list environments
\@endparpenalty=0   %% <- don't encourage breaks at end of list environments
\@itempenalty=0     %% <- don't encourage breaks between items
\makeatother        %% <- revert @

% Adding a framed box around text
\usepackage[most]{tcolorbox}
\usepackage{thmtools}
\newtcolorbox{callout}[1][]{%
  colback=calloutbackground,
  colframe=calloutborder,
  parbox=false,
  leftrule=0.6em,
  fontupper=\sourcesanspro\small,
  breakable = false,
  title={#1},
  fonttitle=\bfseries\sourcesanspro\normalsize,
  sharp corners,
  rounded corners = uphill,
  arc=10pt,
  toptitle=0.4em,
  bottomtitle=0.4em,
}

% Definitions and examples have left margin
\newtcolorbox{exenv}{
  %blanker,
  breakable = true,
  leftrule = 2em,
  toprule = 0.1em,
  bottomrule = 0.1em,
  rightrule = 0.1em,
  colframe = exampleborder,
  colback = examplebackground,
  parbox = false,
}

\newtcolorbox{defenv}{
  breakable = true,
  leftrule = 2em,
  colframe = definitionborder,
  colback = definitionbackground,
  parbox = false,
  toptitle=0em,
  bottomtitle=0em,
}

% Definitions and examples have left margin (tcolorbox)
\BeforeBeginEnvironment{example}{\begin{exenv}}
  \AfterEndEnvironment{example}{\end{exenv}}

\BeforeBeginEnvironment{definition}{\begin{defenv}}
  \AfterEndEnvironment{definition}{\end{defenv}}

% Shrink space between figure and rest
\BeforeBeginEnvironment{figure}{\vskip-2ex}
\AfterEndEnvironment{figure}{\vskip-2ex}

% tcolorbox to keep text together
\newtcolorbox{keepTogether}{%
  breakable = false,
  parbox = true,
  blanker,
}

% Theorems
\usepackage{amsthm}
\newtheoremstyle{definition}
                {0em} % Space above
                {0.5em} % Space below
                {} % Body font
                {} % Indent of title
                {\itshape\bfseries}  % Title font
                {.} % Separator character
                {\newline} % Space after separator
                {} % Head template

% Dependencies for merging with external cover page
\usepackage{pdfpages}
\let\oldmaketitle\maketitle
\AtBeginDocument{\let\maketitle\relax}
